<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>JSON数据表单展示</title>
<style>
:root {
  --bg: #0b0c0f;
  --card: #14161a;
  --text: #e6e8eb;
  --muted: #9aa3ab;
  --accent: #3b82f6;
  --accent-2: #22c55e;
  --border: #23262b;
  --danger: #ef4444;
}
* { box-sizing: border-box }
body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
.container { max-width: 1000px; margin: 0 auto; padding: 24px }
.card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px }
.toolbar { display: flex; align-items: center; gap: 12px; margin-bottom: 16px }
.btn {
  appearance: none; border: 1px solid var(--border); background: #121318; color: var(--text);
  padding: 8px 14px; border-radius: 8px; cursor: pointer; transition: all .15s ease
}
.btn:hover { border-color: #2c3138; background: #0f1115 }
.btn.primary { background: var(--accent); border-color: var(--accent); color: white }
.btn.primary:hover { filter: brightness(1.05) }
.btn.success { background: var(--accent-2); border-color: var(--accent-2); color: white }
.status { min-height: 24px; font-size: 14px; color: var(--muted) }
.form { display: grid; grid-template-columns: 1fr; gap: 10px }
.row { display: grid; grid-template-columns: 280px 1fr auto; gap: 10px; align-items: start }
.label { font-weight: 600; color: var(--muted); padding-top: 8px; word-break: break-all }
.input, .textarea {
  width: 100%; background: #0e1014; color: var(--text); border: 1px solid var(--border);
  border-radius: 8px; padding: 8px 10px; font-size: 14px
}
.textarea { min-height: 40px; resize: vertical }
.copy-btn { white-space: nowrap }
.header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px }
.title { font-size: 18px; font-weight: 700 }
.error { color: var(--danger) }
.small { font-size: 12px; color: var(--muted) }
.empty { color: var(--muted); text-align: center; padding: 24px }
@media (max-width: 820px) {
  .row { grid-template-columns: 1fr; }
  .label { padding-top: 0 }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">产品数据表单展示</div>
    <div class="toolbar">
      <button id="refreshBtn" class="btn primary">刷新</button>
    </div>
  </div>

  <div class="card">
    <div id="status" class="status"></div>
    <div id="form" class="form"></div>
  </div>
</div>

<script>
const endpoint = "https://s.jupai.net/get_product";

function buildSrcDoc(url) {
  return `<!DOCTYPE html><html><body><script>
const endpoint = ${JSON.stringify(url)};
const corsCandidates = [
  (u) => u,
  (u) => 'https://cors.isomorphic-git.org/' + u,
  (u) => 'https://corsproxy.io/?' + u,
  (u) => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(u)
];
(async () => {
  let lastErr;
  for (const build of corsCandidates) {
    const target = build(endpoint);
    try {
      const res = await fetch(target, { method: 'GET', cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const text = await res.text();
      parent.postMessage({ type: 'json', data: JSON.parse(text) }, '*');
      return;
    } catch (err) { lastErr = err; }
  }
  parent.postMessage({ type: 'error', message: String(lastErr || '无法获取数据') }, '*');
})();
<\/script></body></html>`;
}

function toStringValue(v) {
  if (v === null || v === undefined) return "";
  if (typeof v === "object") return JSON.stringify(v);
  return String(v);
}

function flatten(obj, path = []) {
  const out = [];
  const isPrimitive = (v) => v === null || typeof v !== "object";
  if (isPrimitive(obj)) {
    out.push({ key: path.join("."), value: obj });
    return out;
  }
  if (Array.isArray(obj)) {
    obj.forEach((item, i) => {
      if (isPrimitive(item)) {
        out.push({ key: [...path, `[${i}]`].join("."), value: item });
      } else {
        out.push(...flatten(item, [...path, `[${i}]`]));
      }
    });
    return out;
  }
  Object.keys(obj).forEach((k) => {
    const v = obj[k];
    if (isPrimitive(v)) {
      out.push({ key: [...path, k].join("."), value: v });
    } else {
      out.push(...flatten(v, [...path, k]));
    }
  });
  return out;
}

function clear(el) { while (el.firstChild) el.removeChild(el.firstChild) }

function showStatus(text, type = "info") {
  const status = document.getElementById("status");
  status.textContent = text;
  status.className = type === "error" ? "status error" : "status";
}

async function copyText(text, btn) {
  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(text);
    } else {
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
    }
    const prev = btn.textContent;
    btn.textContent = "已复制";
    btn.classList.add("success");
    setTimeout(() => { btn.textContent = prev; btn.classList.remove("success") }, 800);
  } catch {
    const prev = btn.textContent;
    btn.textContent = "复制失败";
    setTimeout(() => { btn.textContent = prev }, 800);
  }
}

function renderForm(data) {
  const form = document.getElementById("form");
  clear(form);

  const entries = flatten(data);
  if (!entries.length) {
    const empty = document.createElement("div");
    empty.className = "empty";
    empty.textContent = "返回数据为空";
    form.appendChild(empty);
    return;
  }

  entries.forEach(({ key, value }) => {
    const row = document.createElement("div");
    row.className = "row";

    const label = document.createElement("div");
    label.className = "label";
    label.textContent = key || "(root)";

    const str = toStringValue(value);
    const isLong = str.length > 80 || str.indexOf("\n") >= 0;

    let field;
    if (isLong) {
      field = document.createElement("textarea");
      field.className = "textarea";
      field.rows = Math.min(10, Math.max(2, Math.ceil(str.length / 80)));
      field.readOnly = true;
      field.value = str;
    } else {
      field = document.createElement("input");
      field.className = "input";
      field.readOnly = true;
      field.value = str;
    }

    const copyBtn = document.createElement("button");
    copyBtn.className = "btn copy-btn";
    copyBtn.textContent = "复制";
    copyBtn.addEventListener("click", () => copyText(str, copyBtn));

    row.appendChild(label);
    row.appendChild(field);
    row.appendChild(copyBtn);
    form.appendChild(row);
  });

  showStatus(`已加载 ${entries.length} 个参数`);
}

function startLoad() {
  showStatus("加载中…");
  const card = document.querySelector(".card");
  let iframe = document.getElementById("loaderFrame");
  if (iframe) iframe.remove();
  iframe = document.createElement("iframe");
  iframe.id = "loaderFrame";
  iframe.style.display = "none";
  iframe.setAttribute("sandbox", "allow-scripts");
  iframe.srcdoc = buildSrcDoc(endpoint);
  card.appendChild(iframe);
}

document.getElementById("refreshBtn").addEventListener("click", startLoad);
window.addEventListener("message", (e) => {
  if (!e.data) return;
  if (e.data.type === "json") {
    renderForm(e.data.data);
  } else if (e.data.type === "error") {
    showStatus("加载失败：可能被跨域限制或接口不可用", "error");
  }
});
document.addEventListener("DOMContentLoaded", startLoad);
</script>
</body>
</html>
